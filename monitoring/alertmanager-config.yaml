apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: stock-analysis
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.company.com:587'
      smtp_from: 'alerts@company.com'
      smtp_auth_username: 'alerts@company.com'
      smtp_auth_password: 'password'
      
    # è·¯ç”±é…ç½®
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'default-receiver'
      routes:
        # å…³é”®å‘Šè­¦ç«‹å³é€šçŸ¥
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 0s
          repeat_interval: 5m
          
        # APIç›¸å…³å‘Šè­¦
        - match:
            service: api
          receiver: 'api-team'
          
        # æ•°æ®åº“å‘Šè­¦
        - match:
            service: database
          receiver: 'dba-team'
          
        # ç³»ç»Ÿå‘Šè­¦
        - match:
            service: system
          receiver: 'ops-team'
          
        # ä¸šåŠ¡å‘Šè­¦
        - match:
            service: business
          receiver: 'dev-team'

    # æŠ‘åˆ¶è§„åˆ™
    inhibit_rules:
      # å¦‚æœæ•´ä¸ªæœåŠ¡downäº†ï¼Œå°±ä¸è¦å‘é€å…¶ä»–ç›¸å…³å‘Šè­¦
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['service']
        
      # å¦‚æœèŠ‚ç‚¹downäº†ï¼Œå°±ä¸è¦å‘é€è¯¥èŠ‚ç‚¹ä¸Šçš„å…¶ä»–å‘Šè­¦
      - source_match:
          alertname: 'NodeDown'
        target_match_re:
          alertname: '.*'
        equal: ['instance']

    # æ¥æ”¶å™¨é…ç½®
    receivers:
      - name: 'default-receiver'
        email_configs:
          - to: 'ops@company.com'
            subject: '[ALERT] {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              Alert: {{ .Annotations.summary }}
              Description: {{ .Annotations.description }}
              Labels: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
              {{ end }}

      - name: 'critical-alerts'
        email_configs:
          - to: 'ops@company.com,dev@company.com,dba@company.com'
            subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
            body: |
              ğŸš¨ CRITICAL ALERT ğŸš¨
              
              {{ range .Alerts }}
              Alert: {{ .Annotations.summary }}
              Description: {{ .Annotations.description }}
              Severity: {{ .Labels.severity }}
              Service: {{ .Labels.service }}
              Time: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              
              Labels: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
              {{ end }}
              
              Please take immediate action!
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
            channel: '#alerts-critical'
            title: 'ğŸš¨ Critical Alert: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Service:* {{ .Labels.service }}
              *Severity:* {{ .Labels.severity }}
              {{ end }}
        webhook_configs:
          - url: 'http://alertmanager-webhook:8080/webhook'
            send_resolved: true

      - name: 'api-team'
        email_configs:
          - to: 'api-team@company.com'
            subject: '[API Alert] {{ .GroupLabels.alertname }}'
            body: |
              APIæœåŠ¡å‘Šè­¦é€šçŸ¥
              
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              æœåŠ¡: {{ .Labels.service }}
              ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
            channel: '#api-alerts'
            title: 'API Alert: {{ .GroupLabels.alertname }}'

      - name: 'dba-team'
        email_configs:
          - to: 'dba@company.com'
            subject: '[Database Alert] {{ .GroupLabels.alertname }}'
            body: |
              æ•°æ®åº“å‘Šè­¦é€šçŸ¥
              
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              æ•°æ®åº“: {{ .Labels.instance }}
              ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
            channel: '#database-alerts'
            title: 'Database Alert: {{ .GroupLabels.alertname }}'

      - name: 'ops-team'
        email_configs:
          - to: 'ops@company.com'
            subject: '[System Alert] {{ .GroupLabels.alertname }}'
            body: |
              ç³»ç»Ÿå‘Šè­¦é€šçŸ¥
              
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              èŠ‚ç‚¹: {{ .Labels.instance }}
              ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
            channel: '#system-alerts'
            title: 'System Alert: {{ .GroupLabels.alertname }}'

      - name: 'dev-team'
        email_configs:
          - to: 'dev@company.com'
            subject: '[Business Alert] {{ .GroupLabels.alertname }}'
            body: |
              ä¸šåŠ¡å‘Šè­¦é€šçŸ¥
              
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              æœåŠ¡: {{ .Labels.service }}
              ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
            channel: '#business-alerts'
            title: 'Business Alert: {{ .GroupLabels.alertname }}'

---
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-secrets
  namespace: stock-analysis
type: Opaque
stringData:
  smtp_password: "your_smtp_password"
  slack_webhook_url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
  webhook_url: "http://alertmanager-webhook:8080/webhook"